# Story 4.1: Archive Folder Creation and Management

## Status
Draft

## Story
**As a** user,
**I want** the application to create and manage an archive folder for storing duplicate images,
**so that** archived images are organized in a predictable location separate from my active photo collection.

## Acceptance Criteria
1. "Archived" folder is created in the user's home directory if it doesn't exist
2. Archive folder location is configurable in application settings
3. Folder creation handles permission issues gracefully with clear error messages
4. Archive folder path is validated and displayed to user before operations
5. Application checks available disk space before archival operations
6. Archive folder structure is documented and consistent
7. User can browse to archive folder location from within the application
8. Archive folder creation respects macOS security and permission requirements

## Tasks / Subtasks
- [ ] Task 1: Implement default archive folder creation (AC: 1, 6)
  - [ ] Create "Archived" folder in user's home directory by default
  - [ ] Implement consistent folder structure and naming
  - [ ] Add metadata file to document archive purpose and format
  - [ ] Handle folder creation with proper macOS permissions
- [ ] Task 2: Add configurable archive location settings (AC: 2, 4)
  - [ ] Add archive location setting to application preferences
  - [ ] Implement folder picker for custom archive locations
  - [ ] Validate selected archive paths for write access
  - [ ] Display current archive location in UI
- [ ] Task 3: Implement robust error handling (AC: 3, 8)
  - [ ] Handle permission denied errors with user-friendly messages
  - [ ] Check and request necessary file system permissions on macOS
  - [ ] Validate folder creation in sandboxed environment
  - [ ] Provide actionable error resolution guidance
- [ ] Task 4: Add disk space validation (AC: 5)
  - [ ] Check available disk space before archive operations
  - [ ] Calculate estimated space needed for selected images
  - [ ] Warn user if insufficient space for archive operation
  - [ ] Suggest alternative locations or cleanup options
- [ ] Task 5: Implement archive folder browsing (AC: 7)
  - [ ] Add "Open Archive Folder" button in UI
  - [ ] Integrate with macOS Finder for folder browsing
  - [ ] Show archive folder statistics (file count, total size)
  - [ ] Provide archive folder management options
- [ ] Task 6: Add comprehensive testing and validation
  - [ ] Test folder creation across different macOS versions
  - [ ] Test permission handling in sandboxed environment
  - [ ] Validate disk space checking accuracy
  - [ ] Test custom archive location functionality

## Dev Notes

### Archive Strategy (Based on PRD and Competitive Analysis)
The PRD specifies a simple archive approach, but competitive analysis shows opportunities for enhancement:

**PRD Specification**:
- Create "Archived" folder in user's home directory
- Move selected images directly to archive folder
- Maintain original filenames

**Enhanced Strategy (This Story)**:
- Configurable archive location for professional users
- Proper macOS permission handling
- Disk space validation
- Archive documentation and metadata

### User Personas Requirements
- **Sarah (Family)**: Simple, predictable archive location in home directory
- **Marcus (Professional)**: Configurable archive location, possibly on external drives
- **David (Tech)**: Full control over archive location and organization
- **Linda (Librarian)**: Institutional archive locations with proper documentation

### macOS Integration Requirements
**File System Permissions**:
- Request appropriate file access permissions
- Handle App Sandbox restrictions properly
- Respect macOS security and privacy settings
- Integrate with macOS permission dialogs

**Native Integration**:
- Use NSOpenPanel for folder selection
- Integrate with Finder for archive browsing
- Support macOS path conventions and formats
- Handle network drives and external storage

### Archive Folder Structure
```
~/Archived/                    # Default location
├── .photo_archivist_info      # Metadata file
├── archived_images/           # Actual archived images
└── logs/                      # Archive operation logs (future)
```

### Disk Space Calculation
```python
def calculate_archive_space_needed(selected_images):
    total_size = 0
    for image_path in selected_images:
        try:
            total_size += os.path.getsize(image_path)
        except OSError:
            continue  # Skip inaccessible files
    
    # Add 10% buffer for file system overhead
    return int(total_size * 1.1)

def check_available_space(archive_path):
    statvfs = os.statvfs(archive_path)
    return statvfs.f_frsize * statvfs.f_available
```

### Settings Integration
**Configuration Options**:
- Archive folder location (default: ~/Archived)
- Archive organization method (flat vs date-based)
- Automatic cleanup options
- Archive operation logging level

**Settings Storage**:
- Use QSettings for cross-platform settings storage
- Store settings in platform-appropriate locations
- Support settings import/export for backup

### Error Handling Scenarios
**Permission Issues**:
- User doesn't have write access to selected location
- App Sandbox restrictions prevent folder creation
- Network drive disconnections during setup
- External drive not mounted

**Space Issues**:
- Insufficient disk space for archive operation
- Archive location becomes full during operation
- Quota limits on network drives

**Path Issues**:
- Invalid characters in archive path
- Path length limitations on file system
- Archive location doesn't exist or becomes inaccessible

### Integration with Archive Operations
This story establishes the foundation for Stories 4.2-4.5:
- **Story 4.2**: Uses archive folder for secure file moves
- **Story 4.3**: Shows archive progress and completion
- **Story 4.4**: Handles errors during archive operations
- **Story 4.5**: Provides archive operation summaries

### Testing Strategy
**Functional Testing**:
- Test default archive folder creation
- Test custom archive location selection
- Test permission error scenarios
- Test disk space validation accuracy

**Integration Testing**:
- Test with various macOS versions
- Test in sandboxed vs non-sandboxed environments
- Test with network drives and external storage
- Test settings persistence across app restarts

**User Experience Testing**:
- Validate error message clarity and actionability
- Test folder browsing integration with Finder
- Validate archive folder organization consistency

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
*This section will be populated by the QA Agent during review*
