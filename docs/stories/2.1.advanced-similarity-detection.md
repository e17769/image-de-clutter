# Story 2.1: Advanced Similarity Detection with CNN

## Status
Draft

## Story
**As a** user,
**I want** to detect visually similar images (not just exact duplicates),
**so that** I can find near-duplicate photos that might have slight differences in quality or editing.

## Acceptance Criteria
1. CNN-based similarity detection is implemented using imagededup's CNN features
2. Both exact duplicates (hash-based) and similar images (CNN-based) are detected in single scan
3. Similar image groups are clearly distinguished from exact duplicate groups in results
4. CNN model loading and initialization is handled efficiently
5. Memory usage is optimized for CNN operations on large image sets
6. Error handling for CNN model loading failures or insufficient system resources
7. Progress indication shows both hash and CNN processing phases

## Tasks / Subtasks
- [ ] Task 1: Implement CNN-based similarity detection (AC: 1, 2)
  - [ ] Integrate imagededup CNN method alongside existing PHash
  - [ ] Download and initialize pre-trained CNN model
  - [ ] Implement combined detection workflow (hash + CNN)
  - [ ] Handle CNN model caching and reuse
- [ ] Task 2: Optimize memory usage for CNN operations (AC: 5)
  - [ ] Implement batch processing for CNN analysis
  - [ ] Add memory monitoring and cleanup
  - [ ] Optimize image preprocessing for CNN input
  - [ ] Implement progressive processing for large sets
- [ ] Task 3: Enhance results display for similarity types (AC: 3)
  - [ ] Distinguish exact duplicates from similar images in UI
  - [ ] Add similarity confidence scores to results
  - [ ] Group results by detection method (hash vs CNN)
  - [ ] Show algorithm used for each duplicate group
- [ ] Task 4: Add robust error handling (AC: 6)
  - [ ] Handle CNN model download/loading failures
  - [ ] Graceful degradation to hash-only detection
  - [ ] Memory exhaustion error handling
  - [ ] GPU/CPU compatibility checks
- [ ] Task 5: Implement dual-phase progress tracking (AC: 7)
  - [ ] Show separate progress for hash and CNN phases
  - [ ] Update progress indicators for each processing stage
  - [ ] Provide time estimates for CNN processing
  - [ ] Allow cancellation during CNN phase
- [ ] Task 6: Add comprehensive testing and validation
  - [ ] Test CNN detection accuracy with known similar images
  - [ ] Performance testing with large image sets
  - [ ] Memory usage validation
  - [ ] Error condition testing

## Dev Notes

### CNN vs Hash-Based Detection
**Hash-based (PHash/DHash)**:
- Fast processing (500+ images/minute)
- Detects exact and near-exact duplicates
- Low memory usage
- Reliable for obvious duplicates

**CNN-based Detection**:
- Slower processing (~100 images/minute)
- Detects visually similar images with different qualities
- Higher memory usage (requires GPU/optimized CPU)
- Better for finding edited versions, different crops, etc.

### Competitive Advantage
This story implements our key differentiator from the competitive analysis:
- **PhotoSweeper Pro**: Uses proprietary similarity algorithms
- **Our approach**: Open source imagededup with explainable CNN results
- **Transparency**: Users can understand why images are marked as similar

### User Personas Impact
- **Sarah (Family)**: Benefits from finding similar vacation photos, burst shots
- **Marcus (Professional)**: Finds similar compositions, different editing versions
- **David (Tech)**: Appreciates open CNN model and configurable parameters
- **Linda (Librarian)**: Needs conservative similarity detection for archival integrity

### imagededup CNN Implementation
```python
from imagededup import methods

# Initialize CNN method
cnn_encoder = methods.CNN()

# Generate CNN encodings (slower but more accurate)
cnn_encodings = cnn_encoder.encode_images(image_dir='path/to/images')

# Find duplicates with similarity threshold
duplicates_cnn = cnn_encoder.find_duplicates(
    encoding_map=cnn_encodings,
    max_distance_threshold=0.90  # Configurable similarity threshold
)
```

### Performance Optimization Strategy
1. **Batch Processing**: Process images in batches to manage memory
2. **Progressive Loading**: Load and process images incrementally
3. **Model Caching**: Cache CNN model between scans
4. **Memory Monitoring**: Track memory usage and cleanup as needed
5. **Fallback Strategy**: Degrade to hash-only if CNN fails

### Memory Management
- CNN operations can use 1-2GB RAM for model and processing
- Implement batch sizes based on available system memory
- Clear intermediate results to prevent memory leaks
- Monitor total memory usage during processing

### Error Handling Scenarios
- CNN model download failures (network issues)
- Insufficient memory for CNN processing
- GPU availability and compatibility
- Corrupted model files
- System resource exhaustion

### Results Data Structure Enhancement
```python
{
    'group_id': unique_identifier,
    'detection_method': 'cnn' | 'hash' | 'combined',
    'similarity_score': 0.0-1.0,
    'confidence_level': 'high' | 'medium' | 'low',
    'images': [
        {
            'path': '/full/path/to/image.jpg',
            'hash_value': 'phash_result',
            'cnn_encoding': 'cnn_feature_vector',
            'similarity_to_group': 0.95
        }
    ]
}
```

### UI Enhancements Needed
- Visual indicators for detection method (hash vs CNN)
- Similarity confidence display
- Processing phase indicators
- Memory usage monitoring display
- Graceful error messaging for CNN failures

### Testing Strategy
- Create test sets with known similar images (different qualities, crops)
- Performance benchmarking with various image set sizes
- Memory usage profiling during CNN operations
- Error condition testing (no GPU, low memory, etc.)
- Accuracy validation against known similar image pairs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
*This section will be populated by the QA Agent during review*
